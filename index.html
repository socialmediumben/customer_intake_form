<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Medium - Customer Intake Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .waiver-box {
            height: 200px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-y: auto;
            font-size: 0.875rem;
            line-height: 1.25rem;
            color: #475569;
            margin-top: 0.5rem;
        }
        #signature-canvas {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            width: 100%;
            height: auto;
        }
        .hidden {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the collapsible waiver details/summary */
        details > summary {
            cursor: pointer;
            font-weight: 500;
            color: #1e293b; /* slate-800 */
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div id="app-container" class="w-full max-w-4xl bg-white p-8 rounded-2xl shadow-lg transition-all duration-500">
        
        <!-- Main Application View -->
        <div id="main-app-view">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-slate-800">Social Medium</h1>
                <p class="text-slate-500 mt-2">New Member Intake & Waiver</p>
            </div>

            <form id="intake-form">
                <fieldset id="form-fieldset" disabled>
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-slate-700 border-b pb-2 mb-4">1. Personal Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="first-name" class="block text-sm font-medium text-slate-600 mb-1">Preferred Name</label>
                                <input type="text" id="first-name" name="first-name" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="last-name" class="block text-sm font-medium text-slate-600 mb-1">Last Name</label>
                                <input type="text" id="last-name" name="last-name" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                             <div>
                                <label for="legal-name" class="block text-sm font-medium text-slate-600 mb-1">Legal Name <span class="text-slate-400">(If Different)</span></label>
                                <input type="text" id="legal-name" name="legal-name" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                             <div>
                                <label for="birthday" class="block text-sm font-medium text-slate-600 mb-1">Birthday</label>
                                <input type="date" id="birthday" name="birthday" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="email" class="block text-sm font-medium text-slate-600 mb-1">Email Address</label>
                                <input type="email" id="email" name="email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <div>
                                <label for="phone" class="block text-sm font-medium text-slate-600 mb-1">Phone Number</label>
                                <input type="tel" id="phone" name="phone" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                            <!-- Container for dynamically added optional fields -->
                            <div id="dynamic-attributes-container" class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                        </div>
                    </div>

                    <!-- Minors Section -->
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-slate-700 border-b pb-2 mb-4">Minors</h2>
                        <div id="minors-container">
                            <!-- Dynamic minor forms will be injected here -->
                        </div>
                        <div id="add-minor-button-container" class="mt-4">
                             <button type="button" id="add-minor-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-300">
                                Add Minor
                            </button>
                        </div>
                    </div>


                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-slate-700 border-b pb-2 mb-4">2. About You (Guardian)</h2>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 mb-2">What are your interests? (Select all that apply)</label>
                            <div id="interests-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm min-h-[6rem]">
                                <div id="interests-loader" class="flex items-center space-x-2 text-slate-500 col-span-full">
                                    <div class="loader"></div>
                                    <span>Loading options...</span>
                                </div>
                            </div>
                             <div class="mt-4">
                                <label for="custom-interests" class="block text-sm font-medium text-slate-600 mb-1">Other Interests <span class="text-slate-400">(Optional)</span></label>
                                <input type="text" id="custom-interests" name="square:44d0b181-7c7b-4c27-97ee-14154777ee7d" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            </div>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-slate-700 border-b pb-2 mb-4">3. Agreements & Waiver</h2>
                        <details>
                            <summary class="text-blue-600 hover:underline">Click to Read Activity Waiver & Photo Release</summary>
                            <div class="waiver-box">
                                <strong>THIS ACTIVITY WAIVER (this "Agreement") IS A RELEASE OF LIABILITY AND INDICATES YOUR ASSUMPTION OF THE DIRECT AND INHERENT RISKS ASSOCIATED WITH THE ACTIVITY.</strong><br><br>
                                <strong>BETWEEN:</strong><br>
                                IN CONSIDERATION OF the covenants and agreements contained in this Agreement and other good and valuable consideration, the receipt of which is hereby acknowledged, the parties to this Agreement agree as follows:<br><br>
                                <strong>Consideration</strong><br>
                                Being of lawful age and in consideration of being permitted to participate in the activity described below, the Participant releases and forever discharges the Activity Provider, its owners, directors, officers, employees, agents, assigns, legal representatives and successors from all manner of actions, causes of action, debts, accounts, bonds, contracts, claims and demands for or by reason of any injury to person or property, including injury resulting in the death of the Participant, which has been or may be sustained as a consequence of the Participant's participation in the activity described below, and not withstanding that such damage, loss or injury may have been caused solely or partly by the negligence of the Activity Provider.<br>
                                The Releasor understands that the Releasor would not be permitted to participate in the activity described below unless the Releasor signed this Agreement.<br><br>
                                <strong>Details of Activity</strong><br>
                                The Participant will participate in the following activity/s: crafting, building, making things, classes, etc. from The Shop Class LLC (DBA Social Medium)--including but not limited to, necessary rigorous and/or dangerous activity associated with crafting, glues and chemicals, electronics, using tool and blades, etc.) and acknowledges any inherent, implied, and necessary risks associated with the same.<br><br>
                                <strong>Concurrent Release</strong><br>
                                The Participant acknowledges that this Agreement is given with the express intention of effecting the extinguishment of certain obligations owed to the Participant and with the intention of binding the Participant's spouse, heirs, executors, administrators, legal representatives and assigns.<br><br>
                                <strong>Fitness to Participate</strong><br>
                                The Participant acknowledges that the Participant does not have any physical limitations, medical ailments, physical or mental disabilities that would limit or prevent the Participant from participating in the above mentioned activity. If required, the Participant will obtain a medical examination and clearance.<br><br>
                                <strong>Full and Final Settlement</strong><br>
                                The Participant hereby acknowledges and agrees that the Participant has carefully read this Agreement, that the Participant fully understands the same, and that the Participant is freely and voluntarily executing the same.<br>
                                The Participant understands that by signing this Agreement, the Participant agrees to be forever prevented from suing or otherwise claiming against the Activity Provider for any property loss or personal injury that the Participant may sustain while participating in or preparing for the above noted activity.<br>
                                The Participant has been given the opportunity and has been encouraged to seek independent legal advice prior to signing this Agreement.<br>
                                This Agreement contains the entire agreement between the parties to this Agreement and the terms of this Agreement are contractual and not a mere recital.<br><br>
                                <strong>Governing Law</strong><br>
                                This Agreement will be construed in accordance with and governed by the laws of the State of Califonia.<br><br>
                                <strong>Duration:</strong><br>
                                For recurring participants, this agreement will apply to all activities occurring between the parties during the calendar year of the effective date of signature unless otherwise revoked in a writing provided by either party, to the other.<br><br>
                                <strong>Photo and Video Release</strong><br>
                                By signing this agreement, the signatory gives the Activity Provider authorization record the signatory on video, photos and other mediums and to distribute and reproduce the materials for the following purposes: Portfolio showcase, advertising, marketing, branding, educational, digital promotions, internet videos, online courses, media, other commercial or non-commercial purposes.<br><br>
                                <strong>Age Verification</strong><br>
                                By signing this agreement, the signatory expressly states that he/she is at least 18 years of age. The signatory also expressly states that they have authority to authorize participation of the minor in the above-mentioned activity/s and further agrees to indemnify and hold harmless The Shop Class LLC (DBA Social Medium) from all liability.<br><br>
                                IN WITNESS WHEREOF the Participant and Activity Provider have duly affixed their signatures below.
                            </div>
                        </details>
                        <div class="mt-4">
                            <label class="flex items-center">
                                <input type="checkbox" id="agree-waiver" name="agree-waiver" required class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-slate-700">I have read and agree to the terms for myself and any listed minors.</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-slate-700 border-b pb-2 mb-4">4. Signature</h2>
                        <div class="bg-slate-50 p-2 rounded-lg">
                            <canvas id="signature-canvas"></canvas>
                        </div>
                        <button type="button" id="clear-signature-btn" class="mt-2 text-sm text-blue-600 hover:underline">Clear Signature</button>
                    </div>

                    <div class="mt-8 text-center">
                        <button type="submit" id="submit-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-slate-400 disabled:cursor-not-allowed">
                            Agree & Submit Waiver
                        </button>
                    </div>
                </fieldset>
            </form>

            <div id="status-message" class="hidden mt-6 p-4 rounded-lg text-center"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 1. CONFIGURATION ---
        const RENDER_BACKEND_URL = 'https://square-checkin-backend.onrender.com';
        let legalNameAttributeKey = null;
        let newWaiverAttributeKey = null;
        let adultAttributeKey = null;
        let minorAttributeKey = null;
        let minorCount = 0;
        let dynamicAttributes = [];

        // --- 2. ELEMENT SELECTORS ---
        const form = document.getElementById('intake-form');
        const submitBtn = document.getElementById('submit-btn');
        const addMinorBtn = document.getElementById('add-minor-btn');
        const minorsContainer = document.getElementById('minors-container');
        const addMinorButtonContainer = document.getElementById('add-minor-button-container');

        // --- 3. FIREBASE & APP INITIALIZATION ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'social-medium-waiver-app';
        let db, auth;
        
        async function main() {
            let firebaseConfig;
            try {
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            } catch (e) {
                console.error("Firebase config is not a valid JSON string.", e);
                firebaseConfig = {}; 
            }

            if (Object.keys(firebaseConfig).length > 0) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('debug');
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    displayMessage('Error connecting to the database service.', 'error');
                }
            } else {
                console.error("Firebase configuration is missing.");
            }

            try {
                await initializeFormFromSquare();
                requestAnimationFrame(resizeCanvas);
            } catch (error) {
                const loader = document.getElementById('interests-loader');
                if(loader) loader.parentElement.innerHTML = `<p class="text-red-600 col-span-full font-medium">Error: Could not load form configuration from server.<br><span class="text-xs text-slate-500">${error.message}</span></p>`;
                console.error("Initialization failed:", error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', main);
        
        async function initializeFormFromSquare() {
            let allAttributes = [];
            let cursor = null;
            
            do {
                const url = new URL(`${RENDER_BACKEND_URL}/api/v2/customers/custom-attribute-definitions`);
                if (cursor) {
                    url.searchParams.append('cursor', cursor);
                }
                
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.errors?.[0]?.detail || response.statusText}`);
                }

                const data = await response.json();
                if (data.custom_attribute_definitions) {
                    allAttributes.push(...data.custom_attribute_definitions);
                }
                cursor = data.cursor;

            } while (cursor);

            if (allAttributes.length === 0) {
                console.warn('No custom attribute definitions found.');
                populateInterests([]);
                return; 
            }

            const legalNameAttr = allAttributes.find(attr => attr.name.toLowerCase() === 'legal name');
            if (legalNameAttr) legalNameAttributeKey = legalNameAttr.key;
            else console.error('Could not find a custom attribute named "Legal Name".');

            const newWaiverAttr = allAttributes.find(attr => attr.name.toLowerCase() === 'new waiver');
            if (newWaiverAttr) newWaiverAttributeKey = newWaiverAttr.key;
            else console.error('Could not find a custom attribute named "New Waiver".');

            const adultAttr = allAttributes.find(attr => attr.name.toLowerCase() === 'adult');
            if (adultAttr) adultAttributeKey = adultAttr.key;
            else console.error('Could not find a custom attribute named "Adult".');

            const minorAttr = allAttributes.find(attr => attr.name.toLowerCase() === 'minor');
            if (minorAttr) minorAttributeKey = minorAttr.key;
            else console.error('Could not find a custom attribute named "Minor".');

            const interestAttributes = allAttributes
                .filter(attr => attr.schema?.$ref?.includes('squareup.common.Boolean') && attr.name?.startsWith("T: "))
                .map(attr => ({ key: attr.key, name: attr.name }));
            
            populateInterests(interestAttributes);

            dynamicAttributes = allAttributes.filter(attr => attr.name?.startsWith("B: ") || attr.name?.startsWith("W: "));
            populateDynamicAttributes(dynamicAttributes);
        }

        function populateInterests(attributes) {
            const container = document.getElementById('interests-container');
            const loader = document.getElementById('interests-loader');
            const fieldset = document.getElementById('form-fieldset');
            
            if(loader) loader.remove();

            if (attributes.length === 0) {
                container.innerHTML = '<p class="text-slate-500 col-span-full">No "T: " interests found.</p>';
            } else {
                 attributes.forEach(attr => {
                    const displayName = attr.name.replace(/^T: /, '');
                    const checkboxId = `interest-${attr.key}`;
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `<label for="${checkboxId}" class="flex items-center p-2 rounded-lg hover:bg-slate-50 transition cursor-pointer"><input type="checkbox" name="interests" id="${checkboxId}" value="${attr.key}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mr-2"> ${displayName}</label>`;
                    container.appendChild(wrapper);
                });
            }
            fieldset.disabled = false;
        }

        function populateDynamicAttributes(attributes) {
            const container = document.getElementById('dynamic-attributes-container');
            attributes.forEach(attr => {
                const displayName = attr.name.replace(/^(B: |W: )/, '');
                const inputId = `dynamic-${attr.key}`;
                const fieldHTML = `
                    <div>
                        <label for="${inputId}" class="block text-sm font-medium text-slate-600 mb-1">${displayName} <span class="text-slate-400">(Optional)</span></label>
                        <input type="text" id="${inputId}" name="${attr.key}" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', fieldHTML);
            });
        }

        // --- 5. DYNAMIC MINOR FORM LOGIC ---
        addMinorBtn.addEventListener('click', () => {
            minorCount++;
            const minorFormHTML = `
                <div class="mt-6 p-4 border rounded-lg bg-gray-50" id="minor-section-${minorCount}">
                    <h3 class="text-lg font-semibold text-slate-600 mb-4">Minor ${minorCount} Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="first-name-minor-${minorCount}" class="block text-sm font-medium text-slate-600 mb-1">Preferred Name</label>
                            <input type="text" id="first-name-minor-${minorCount}" name="first-name-minor-${minorCount}" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="last-name-minor-${minorCount}" class="block text-sm font-medium text-slate-600 mb-1">Last Name</label>
                            <input type="text" id="last-name-minor-${minorCount}" name="last-name-minor-${minorCount}" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="legal-name-minor-${minorCount}" class="block text-sm font-medium text-slate-600 mb-1">Legal Name <span class="text-slate-400">(If Different)</span></label>
                            <input type="text" id="legal-name-minor-${minorCount}" name="legal-name-minor-${minorCount}" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                        <div>
                            <label for="birthday-minor-${minorCount}" class="block text-sm font-medium text-slate-600 mb-1">Birthday</label>
                            <input type="date" id="birthday-minor-${minorCount}" name="birthday-minor-${minorCount}" required class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                        </div>
                    </div>
                </div>
            `;
            minorsContainer.insertAdjacentHTML('beforeend', minorFormHTML);
            addMinorButtonContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
        });

        // --- 6. SIGNATURE PAD LOGIC ---
        const canvas = document.getElementById('signature-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false, lastX = 0, lastY = 0;

        function resizeCanvas() {
            if (!canvas.parentElement || canvas.offsetParent === null) return;
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
            if (canvas.width > 0 && canvas.height > 0) {
                tempCtx.drawImage(canvas, 0, 0);
            }
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientWidth / 3; 
            if (tempCanvas.width > 0 && tempCanvas.height > 0) {
                ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width, tempCanvas.height, 0, 0, canvas.width, canvas.height);
            }
            ctx.lineCap = 'round'; ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 3;
        }
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
            [lastX, lastY] = [x, y];
        }
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            [lastX, lastY] = [(e.clientX || e.touches[0].clientX) - rect.left, (e.clientY || e.touches[0].clientY) - rect.top];
        }
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
        canvas.addEventListener('touchend', () => isDrawing = false);
        document.getElementById('clear-signature-btn').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
        
        // --- 7. FORM SUBMISSION LOGIC ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (isCanvasBlank()) { displayMessage('Signature is required.', 'error'); return; }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            displayMessage('Processing your submission...', 'info');

            const formData = new FormData(form);
            const selectedInterestKeys = [];
            document.querySelectorAll('input[name="interests"]:checked').forEach(checkbox => {
                selectedInterestKeys.push(checkbox.value);
            });

            const dynamicAttributeValues = {};
            dynamicAttributes.forEach(attr => {
                const value = formData.get(attr.key);
                if (value) {
                    dynamicAttributeValues[attr.key] = value;
                }
            });
            
            const customInterestValue = formData.get('square:44d0b181-7c7b-4c27-97ee-14154777ee7d');
            if (customInterestValue) {
                dynamicAttributeValues['square:44d0b181-7c7b-4c27-97ee-14154777ee7d'] = customInterestValue;
            }

            const adultPayload = {
                given_name: formData.get('first-name'),
                family_name: formData.get('last-name'),
                email_address: formData.get('email'),
                phone_number: formData.get('phone'),
                birthday: formData.get('birthday'),
                note: 'Primary Guardian'
            };
            const adultLegalName = formData.get('legal-name');
            const allPromises = [processCustomer(adultPayload, adultLegalName, selectedInterestKeys, false, dynamicAttributeValues)];

            for (let i = 1; i <= minorCount; i++) {
                const minorEmail = `${adultPayload.email_address.split('@')[0]}+minor${i}@${adultPayload.email_address.split('@')[1]}`;
                const minorPayload = {
                    given_name: formData.get(`first-name-minor-${i}`),
                    family_name: formData.get(`last-name-minor-${i}`),
                    email_address: minorEmail,
                    phone_number: adultPayload.phone_number,
                    birthday: formData.get(`birthday-minor-${i}`),
                    note: `Minor, linked to guardian at phone: ${adultPayload.phone_number}`
                };
                const minorLegalName = formData.get(`legal-name-minor-${i}`);
                allPromises.push(processCustomer(minorPayload, minorLegalName, [], true, {}));
            }

            try {
                await Promise.all(allPromises);

                document.getElementById('app-container').innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h1 class="text-2xl font-bold text-slate-800 mt-4">Thank You!</h1>
                        <p class="text-slate-600 mt-2">All intake forms submitted and Square profiles created successfully.</p>
                    </div>`;

            } catch (error) {
                console.error("Error during submission: ", error);
                displayMessage(`An error occurred: ${error.message}.`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Agree & Submit Waiver';
            }
        });

        async function processCustomer(customerPayload, legalName, interestKeys, isMinor, dynamicAttrs) {
            // --- STEP 1: SEARCH FOR/CREATE/UPDATE CUSTOMER ---
            const cleanedPhoneNumber = customerPayload.phone_number.replace(/\D/g, '');
            const searchPayload = {
                query: {
                    filter: {
                        phone_number: { fuzzy: cleanedPhoneNumber }
                    }
                }
            };

            const searchResponse = await fetch(`${RENDER_BACKEND_URL}/api/v2/customers/search`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(searchPayload)
            });

            if (!searchResponse.ok) throw new Error('Failed to search for customer.');
            
            const searchResult = await searchResponse.json();
            let customerId;
            let customerVersion;
            let existingCustomer = null;

            if (searchResult.customers && searchResult.customers.length > 0) {
                // Find a customer with a matching name from the results
                existingCustomer = searchResult.customers.find(c => 
                    c.given_name.toLowerCase() === customerPayload.given_name.toLowerCase() &&
                    c.family_name.toLowerCase() === customerPayload.family_name.toLowerCase()
                );
            }

            if (existingCustomer) {
                // Customer exists, update them
                customerId = existingCustomer.id;
                customerVersion = existingCustomer.version;
                console.log(`Customer ${customerPayload.given_name} found with ID: ${customerId}. Updating...`);

                const updatePayload = { ...customerPayload, version: customerVersion };
                const updateResponse = await fetch(`${RENDER_BACKEND_URL}/api/v2/customers/${customerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatePayload)
                });
                if (!updateResponse.ok) throw new Error(`Failed to update customer ${customerPayload.given_name}.`);

            } else {
                // Customer does not exist, create them
                console.log(`Customer ${customerPayload.given_name} not found. Creating...`);
                customerPayload.idempotency_key = crypto.randomUUID();
                const createResponse = await fetch(`${RENDER_BACKEND_URL}/api/v2/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerPayload)
                });

                if (!createResponse.ok) {
                    const errorData = await createResponse.json();
                    throw new Error(`Square profile creation failed for ${customerPayload.given_name}: ${errorData.errors?.[0]?.detail || createResponse.statusText}`);
                }
                
                const createResult = await createResponse.json();
                customerId = createResult.customer?.id;
                if (!customerId) throw new Error("Could not retrieve customer ID after creation.");
                console.log(`Customer ${customerPayload.given_name} created with ID: ${customerId}`);
            }

            // --- SAVE WAIVER TO FIRESTORE ---
            if (db) {
                const waiverData = { ...customerPayload, customerId, legalName, agreedAt: new Date().toISOString(), signatureDataURL: canvas.toDataURL('image/png'), interests: interestKeys, isMinor, otherAttributes: dynamicAttrs };
                if(waiverData.idempotency_key) delete waiverData.idempotency_key;
                await addDoc(collection(db, `/artifacts/${appId}/public/data/waivers`), waiverData);
            }

            // --- STEP 2: UPSERT CUSTOM ATTRIBUTES ---
            const upsertPromises = [];

            if (newWaiverAttributeKey) upsertPromises.push(upsertCustomAttribute(customerId, newWaiverAttributeKey, true));
            if (isMinor && minorAttributeKey) upsertPromises.push(upsertCustomAttribute(customerId, minorAttributeKey, true));
            else if (!isMinor && adultAttributeKey) upsertPromises.push(upsertCustomAttribute(customerId, adultAttributeKey, true));
            if (legalNameAttributeKey && legalName) upsertPromises.push(upsertCustomAttribute(customerId, legalNameAttributeKey, legalName));
            
            for (const key of interestKeys) {
                upsertPromises.push(upsertCustomAttribute(customerId, key, true));
            }
            
            for (const key in dynamicAttrs) {
                upsertPromises.push(upsertCustomAttribute(customerId, key, dynamicAttrs[key]));
            }

            const results = await Promise.all(upsertPromises);
            for (const response of results) {
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Failed to set a custom attribute:', errorData);
                }
            }
            console.log(`Custom attributes update process completed for ${customerPayload.given_name}.`);
        }
        
        function upsertCustomAttribute(customerId, key, value) {
            const upsertPayload = {
                idempotency_key: crypto.randomUUID(),
                custom_attribute: { value: value }
            };
            return fetch(`${RENDER_BACKEND_URL}/api/v2/customers/${customerId}/custom-attributes/${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(upsertPayload)
            });
        }

        // --- UTILITY FUNCTIONS ---
        function displayMessage(message, type = 'info') {
            const el = document.getElementById('status-message');
            el.innerHTML = message;
            el.className = 'mt-6 p-4 rounded-lg text-center';
            if (type === 'error') el.classList.add('bg-red-100', 'text-red-800');
            else el.classList.add('bg-blue-100', 'text-blue-800');
        }
        
        function isCanvasBlank() {
            if (canvas.width === 0 || canvas.height === 0) return true;
            return !ctx.getImageData(0, 0, canvas.width, canvas.height).data.some(channel => channel !== 0);
        }

        window.addEventListener('resize', resizeCanvas);

    </script>
</body>
</html>
